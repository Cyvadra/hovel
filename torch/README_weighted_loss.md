# 加权损失函数模型修改说明

## 概述

根据您的要求，我已经将模型输出从 `output_dim` 修改为 `3 * output_dim`，并实现了相应的加权损失函数。

## 主要修改

### 1. 模型输出格式修改

**原始格式：**
- 模型输出：`(batch_size, output_dim)`

**新格式：**
- 模型输出：`(batch_size, 3 * output_dim)`
- 对于每个输出维度 i，模型输出三个值：
  - `p1_i`: 权重参数，范围 [-1, 1]
  - `p2_i`: 负值预测
  - `p3_i`: 正值预测

### 2. 损失函数实现

**损失公式：**
```
loss = abs(p1-1)/2 * ori_loss(p2,y) + abs(p1+1)/2 * ori_loss(p3,y)
```

**权重计算逻辑：**
- 当 `p1 < 0` 时：`weight_p2` 更高，更信任 `p2`（负值预测）
- 当 `p1 > 0` 时：`weight_p3` 更高，更信任 `p3`（正值预测）
- 当 `p1 = 0` 时：`weight_p2 = weight_p3 = 0.5`，平等对待两个预测
- **重要**：`p1` 会被限制在 [-1, 1] 范围内，确保权重和始终为1

### 3. 具体示例

#### output_dim = 1 的情况：
```
模型输出：[p1, p2, p3]
预期：p1 ∈ [-1,1], p2 < 0, p3 > 0
损失：abs(p1-1)/2 * MSE(p2,y) + abs(p1+1)/2 * MSE(p3,y)
```

#### output_dim = 2 的情况：
```
模型输出：[p1, p2, p3, p4, p5, p6]
- p1, p2, p3 与 y1 计算损失
- p4, p5, p6 与 y2 计算损失
```

## 代码修改详情

### 1. ImprovedModel 类
- 修改输出层：`self.output_proj = nn.Linear(hidden_size, 3 * output_dim)`
- 更新文档说明新的输出格式

### 2. WeightedCombinedLoss 类
- 新增专门的损失函数类
- 实现权重计算和损失组合逻辑
- 添加监控功能，每1000步打印统计信息

### 3. extract_final_predictions 函数
- 新增辅助函数，从3*output_dim输出中提取最终预测
- 使用权重组合：`final_pred = weight_p2 * p2 + weight_p3 * p3`

### 4. 训练和绘图函数
- 更新训练函数使用新的损失函数
- 修改绘图函数处理新的输出格式
- 更新主函数中的配置信息打印

## 使用方法

### 运行训练
```bash
cd torch
python train.py
```

### 运行测试
```bash
cd torch
python test_weighted_loss.py
```

## 监控信息

训练过程中会每1000步打印以下统计信息：
```
Step 1000 - p1: mean=0.123, std=0.456, p2_mean=-0.789, p3_mean=1.234, w2=0.438, w3=0.562
```

其中：
- `p1`: 权重参数的均值和标准差
- `p2_mean`: 负值预测的均值
- `p3_mean`: 正值预测的均值
- `w2`: p2的权重均值
- `w3`: p3的权重均值

## 预期行为

1. **p1 分布**：应该分布在 [-1, 1] 范围内
2. **p2 分布**：应该倾向于负值
3. **p3 分布**：应该倾向于正值
4. **权重行为**：
   - 当 p1 < 0 时，w2 > w3（更信任负值预测）
   - 当 p1 > 0 时，w3 > w2（更信任正值预测）
   - w2 + w3 = 1（权重和为1）

## 文件列表

- `train.py`: 主要的训练脚本（已修改）
- `test_weighted_loss.py`: 测试脚本（新增）
- `test_weight_fix.py`: 权重计算测试脚本（新增）
- `README_weighted_loss.md`: 本说明文件（新增）

## 注意事项

1. 模型输出维度现在是原来的3倍，需要更多的计算资源
2. 损失函数会自动学习p1的分布，使其能够正确地在p2和p3之间进行选择
3. 最终预测通过权重组合得到，而不是直接使用某个输出
4. 建议监控训练过程中的统计信息，确保模型按预期学习
5. **权重计算修复**：p1会被自动限制在[-1,1]范围内，确保权重和始终为1 